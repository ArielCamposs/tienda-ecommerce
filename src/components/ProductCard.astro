---
import StarRating from "./StarRating.astro";
import WishlistButton from "./WishlistButton.astro";

interface Props {
    id: number;
    name: string;
    price: number;
    image: string;
    category: string;
    rating?: number;
    reviewCount?: number;
    originalPrice?: number;
    discount?: number;
}

const {
    id,
    name,
    price,
    image,
    category,
    rating = 0,
    reviewCount = 0,
    originalPrice,
    discount,
} = Astro.props;
---

<div
    class="product-card bg-white rounded-2xl overflow-hidden hover:shadow-xl transition-shadow duration-300 scale-on-hover fade-in"
    style="position: relative;"
>
    <!-- Wishlist Button -->
    <div class="wishlist-btn-wrapper">
        <WishlistButton
            productId={id}
            productName={name}
            productPrice={price}
            productImage={image}
            size="sm"
        />
    </div>

    {discount && discount > 0 && <div class="discount-badge">-{discount}%</div>}

    <div class="aspect-square bg-gray-100 overflow-hidden">
        <img
            src={image}
            alt={name}
            class="w-full h-full object-cover hover:scale-110 transition-transform duration-500"
        />
    </div>

    <div class="p-6">
        <span
            class="text-xs font-semibold text-blue-600 uppercase tracking-wide"
            >{category}</span
        >
        <h3 class="text-lg font-semibold mt-2 mb-1">{name}</h3>

        {
            rating > 0 && (
                <div class="mb-2">
                    <StarRating
                        rating={rating}
                        size="sm"
                        showCount={true}
                        count={reviewCount}
                    />
                </div>
            )
        }

        <div class="flex items-center justify-between mb-4">
            <div
                class="flex items-center border border-gray-300 rounded-lg overflow-hidden"
            >
                <button
                    class="decrease-qty px-3 py-1 hover:bg-gray-100 transition-colors text-gray-600"
                    >-</button
                >
                <input
                    type="number"
                    value="1"
                    min="1"
                    max="99"
                    class="qty-input w-12 text-center border-x border-gray-300 py-1 text-sm focus:outline-none"
                    readonly
                />
                <button
                    class="increase-qty px-3 py-1 hover:bg-gray-100 transition-colors text-gray-600"
                    >+</button
                >
            </div>
            <div class="text-right">
                {
                    originalPrice && originalPrice > price ? (
                        <>
                            <p class="text-sm text-gray-500 line-through">
                                ${originalPrice.toLocaleString()}
                            </p>
                            <p class="text-2xl font-bold text-red-600">
                                ${price.toLocaleString()}
                            </p>
                        </>
                    ) : (
                        <p class="text-2xl font-bold text-gray-900">
                            ${price.toLocaleString()}
                        </p>
                    )
                }
            </div>
        </div>

        <button
            class="add-to-cart w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors btn-press"
            data-product-id={id}
            data-product-name={name}
            data-product-price={price}
            data-product-image={image}
        >
            Agregar al Carrito
        </button>
    </div>
</div>

<style>
    .wishlist-btn-wrapper {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 10;
    }

    .discount-badge {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        background: #ef4444;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 700;
        font-size: 0.75rem;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }

    /* Hide number input arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .qty-input {
        -moz-appearance: textfield;
    }
</style>

<script>
    import { addToCart } from "../scripts/cart.js";

    // Manejo de cantidad
    document.querySelectorAll(".product-card").forEach((card) => {
        const input = card.querySelector(".qty-input") as HTMLInputElement;
        const decreaseBtn = card.querySelector(".decrease-qty");
        const increaseBtn = card.querySelector(".increase-qty");
        const addToCartBtn = card.querySelector(".add-to-cart") as HTMLElement;

        if (input && decreaseBtn && increaseBtn) {
            decreaseBtn.addEventListener("click", (e) => {
                e.preventDefault(); // Prevenir navegación si está dentro de un link
                e.stopPropagation();
                const currentValue = parseInt(input.value);
                if (currentValue > 1) {
                    input.value = (currentValue - 1).toString();
                }
            });

            increaseBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                const currentValue = parseInt(input.value);
                if (currentValue < 99) {
                    input.value = (currentValue + 1).toString();
                }
            });
        }

        if (addToCartBtn) {
            addToCartBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();

                const btn = e.target as HTMLElement;
                const quantity = input ? parseInt(input.value) : 1;

                const product = {
                    id: parseInt(btn.dataset.productId!),
                    name: btn.dataset.productName!,
                    price: parseFloat(btn.dataset.productPrice!),
                    image: btn.dataset.productImage!,
                    quantity: quantity,
                };

                addToCart(product);

                // Visual feedback
                const originalText = btn.textContent;
                btn.textContent = "✓ Agregado";
                btn.classList.add("bg-green-600", "hover:bg-green-700");
                btn.classList.remove("bg-blue-600", "hover:bg-blue-700");

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove("bg-green-600", "hover:bg-green-700");
                    btn.classList.add("bg-blue-600", "hover:bg-blue-700");
                }, 1500);
            });
        }
    });
</script>
