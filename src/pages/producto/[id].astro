---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import StarRating from "../../components/StarRating.astro";
import ReviewSummary from "../../components/ReviewSummary.astro";
import ReviewList from "../../components/ReviewList.astro";
import ReviewForm from "../../components/ReviewForm.astro";
import {
    getProductReviews,
    getAverageRating,
    getRatingDistribution,
    getReviewCount,
} from "../../data/reviews";
import WishlistButton from "../../components/WishlistButton.astro";

import { products as allProducts } from "../../data/products";

// Esta función es necesaria para generar las páginas estáticas
export async function getStaticPaths() {
    return allProducts.map((product) => ({
        params: { id: product.id.toString() },
        props: { product },
    }));
}

// Obtener el producto desde props
const { product } = Astro.props;

// Obtener datos de reseñas
const productReviews = getProductReviews(product.id);
const averageRating = getAverageRating(product.id);
const reviewCount = getReviewCount(product.id);
const ratingDistribution = getRatingDistribution(product.id);
---

<Layout title={`${product.name} - PlastiClean`}>
    <Header />

    <div class="product-detail-page">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/">Inicio</a>
                <span class="separator">›</span>
                <a href="/productos">Productos</a>
                <span class="separator">›</span>
                <span class="current">{product.name}</span>
            </nav>

            <!-- Product Detail -->
            <div class="product-detail">
                <!-- Image Section -->
                <div class="image-section relative">
                    {
                        product.discount && product.discount > 0 && (
                            <div class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1.5 rounded-lg font-bold shadow-md z-10">
                                -{product.discount}%
                            </div>
                        )
                    }
                    <img
                        src={product.image}
                        alt={product.name}
                        class="product-image"
                    />
                </div>

                <!-- Info Section -->
                <div class="info-section">
                    <div class="product-header">
                        <h1 class="product-title">{product.name}</h1>
                        <WishlistButton
                            productId={product.id}
                            productName={product.name}
                            productPrice={product.price}
                            productImage={product.image}
                            size="lg"
                        />
                    </div>

                    <div class="product-price-container">
                        {
                            product.originalPrice &&
                            product.originalPrice > product.price ? (
                                <div class="flex items-center gap-3">
                                    <span class="text-xl text-gray-500 line-through">
                                        $
                                        {product.originalPrice.toLocaleString(
                                            "es-CL",
                                        )}
                                    </span>
                                    <span class="product-price text-red-600">
                                        ${product.price.toLocaleString("es-CL")}
                                    </span>
                                </div>
                            ) : (
                                <div class="product-price">
                                    ${product.price.toLocaleString("es-CL")}
                                </div>
                            )
                        }
                    </div>

                    <p class="product-description">{product.description}</p>

                    <!-- Features -->
                    <div class="features-section">
                        <h3 class="features-title">Características</h3>
                        <ul class="features-list">
                            {
                                (product.features || []).map((feature) => (
                                    <li class="feature-item">
                                        <svg
                                            class="check-icon"
                                            xmlns="http://www.w3.org/2000/svg"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                        {feature}
                                    </li>
                                ))
                            }
                        </ul>
                    </div>

                    <!-- Add to Cart Section -->
                    <div class="cart-section">
                        <div class="quantity-selector">
                            <button class="qty-btn qty-decrease">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M20 12H4"></path>
                                </svg>
                            </button>
                            <input
                                type="number"
                                id="quantity-input"
                                class="qty-input"
                                value="1"
                                min="1"
                                max="99"
                            />
                            <button class="qty-btn qty-increase">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>

                        <button
                            id="add-to-cart-btn"
                            class="add-to-cart-btn"
                            data-product-id={product.id}
                            data-product-name={product.name}
                            data-product-price={product.price}
                            data-product-image={product.image}
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="cart-icon"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                                ></path>
                            </svg>
                            Agregar al Carrito
                        </button>
                    </div>

                    <!-- Back to Products -->
                    <a href="/productos" class="back-link">
                        ← Volver a productos
                    </a>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section">
                <h2 class="reviews-title">Opiniones de Clientes</h2>

                <ReviewSummary
                    average={averageRating}
                    count={reviewCount}
                    distribution={ratingDistribution}
                />

                <ReviewList reviews={productReviews} maxReviews={5} />

                <div
                    class="mt-12 max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-100"
                >
                    <ReviewForm productId={product.id} />
                </div>
            </div>
        </div>
    </div>

    <Footer />
</Layout>

<script>
    import { addToCart } from "../../scripts/cart.js";

    // Quantity controls
    const qtyInput = document.getElementById(
        "quantity-input",
    ) as HTMLInputElement;
    const decreaseBtn = document.querySelector(".qty-decrease");
    const increaseBtn = document.querySelector(".qty-increase");
    const addToCartBtn = document.getElementById("add-to-cart-btn");

    decreaseBtn?.addEventListener("click", () => {
        const currentValue = parseInt(qtyInput.value);
        if (currentValue > 1) {
            qtyInput.value = (currentValue - 1).toString();
        }
    });

    increaseBtn?.addEventListener("click", () => {
        const currentValue = parseInt(qtyInput.value);
        if (currentValue < 99) {
            qtyInput.value = (currentValue + 1).toString();
        }
    });

    // Validate input
    qtyInput?.addEventListener("input", () => {
        let value = parseInt(qtyInput.value);
        if (isNaN(value) || value < 1) {
            qtyInput.value = "1";
        } else if (value > 99) {
            qtyInput.value = "99";
        }
    });

    // Add to cart
    addToCartBtn?.addEventListener("click", () => {
        const quantity = parseInt(qtyInput.value);
        const product = {
            id: parseInt(addToCartBtn.dataset.productId!),
            name: addToCartBtn.dataset.productName!,
            price: parseFloat(addToCartBtn.dataset.productPrice!),
            image: addToCartBtn.dataset.productImage!,
            quantity: quantity,
        };

        addToCart(product);

        // Visual feedback
        const originalText = addToCartBtn.innerHTML;
        addToCartBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="cart-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Agregado al Carrito
        `;
        addToCartBtn.classList.add("added");

        setTimeout(() => {
            addToCartBtn.innerHTML = originalText;
            addToCartBtn.classList.remove("added");
            qtyInput.value = "1";
        }, 2000);
    });
</script>

<style>
    .product-detail-page {
        min-height: 100vh;
        background: #fafafa;
        padding-top: 56px;
    }

    .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        font-size: 0.875rem;
    }

    .breadcrumb a {
        color: #6b7280;
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: #2563eb;
    }

    .breadcrumb .separator {
        color: #d1d5db;
    }

    .breadcrumb .current {
        color: #111827;
        font-weight: 500;
    }

    .product-detail {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        .product-detail {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
    }

    .image-section {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
        border-radius: 0.75rem;
        padding: 2rem;
    }

    .product-image {
        width: 100%;
        max-width: 500px;
        height: auto;
        object-fit: cover;
        border-radius: 0.5rem;
    }

    .info-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .product-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .product-title {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
        flex: 1;
    }

    .product-price {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2563eb;
    }

    .product-description {
        font-size: 1rem;
        color: #4b5563;
        line-height: 1.6;
    }

    .features-section {
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .features-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 1rem;
    }

    .features-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9375rem;
        color: #374151;
    }

    .check-icon {
        width: 20px;
        height: 20px;
        color: #10b981;
        flex-shrink: 0;
    }

    .cart-section {
        display: flex;
        gap: 1rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .quantity-selector {
        display: flex;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .qty-btn {
        background: white;
        border: none;
        padding: 0.75rem;
        cursor: pointer;
        color: #374151;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        background: #f3f4f6;
    }

    .qty-input {
        width: 60px;
        text-align: center;
        border: none;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        font-size: 1rem;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
    }

    .qty-input:focus {
        outline: none;
    }

    /* Remove arrows from number input */
    .qty-input::-webkit-inner-spin-button,
    .qty-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .qty-input[type="number"] {
        -moz-appearance: textfield;
    }

    .add-to-cart-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.625rem 1.25rem;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .add-to-cart-btn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .add-to-cart-btn.added {
        background: #10b981;
    }

    .cart-icon {
        width: 20px;
        height: 20px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        text-decoration: none;
        font-size: 0.9375rem;
        transition: color 0.2s;
        margin-top: 1rem;
    }

    .back-link:hover {
        color: #2563eb;
    }

    /* Reviews Section */
    .reviews-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 2px solid #e5e7eb;
    }

    .reviews-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2rem;
    }
</style>
